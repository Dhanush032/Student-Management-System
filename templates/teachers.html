
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h3>Teachers</h3>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">+ Add Teacher</button>
</div>

<table class="table table-striped mt-3" id="teachersTable">
    <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Spec</th><th>Actions</th></tr></thead>
    <tbody></tbody>
</table>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Create Teacher</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="createForm">
                <div class="mb-2"><label class="form-label">Name</label><input class="form-control" id="c_name" required></div>
                <div class="mb-2"><label class="form-label">Email</label><input type="email" class="form-control" id="c_email" required></div>
                <div class="mb-2"><label class="form-label">Specialization</label><input class="form-control" id="c_spec"></div>
                <button class="btn btn-primary" type="submit">Create</button>
            </form>
        </div>
    </div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadTeachers() {
        const res = await fetch('/api/teachers/');
        const data = await res.json();
        const tbody = document.querySelector('#teachersTable tbody');
        tbody.innerHTML = '';
        data.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${t.id}</td>
            <td>${t.name}</td>
            <td>${t.email}</td>
            <td>${t.specialization || ''}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editTeacher(${t.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTeacher(${t.id})">Delete</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    async function createTeacher(e) {
        e.preventDefault();
        const body = {
            name: document.getElementById('c_name').value.trim(),
            email: document.getElementById('c_email').value.trim(),
            specialization: document.getElementById('c_spec').value.trim(),
        };
    try {
        const res = await fetch('/api/teachers/', {
            method: 'POST',
            headers: {'Content-Type':'application/json', ...authHeaders()},
            body: JSON.stringify(body)
        });
        if (!res.ok) { return handleApiError(res); }
        await res.json();
        document.querySelector('#createModal .btn-close').click();
        loadTeachers();
        } catch (err) { alert(err.message); }
    }
    async function deleteTeacher(id) {
        if (!confirm('Delete teacher #' + id + '?')) return;
        try {
            const res = await fetch('/api/teachers/' + id + '/', {
                method: 'DELETE',
                headers: authHeaders()
            });
            if (!res.ok) { const d = await res.text(); throw new Error(res.status + ': ' + d); }
            loadTeachers();
        } catch (err) { alert(err.message); }
    }
    async function editTeacher(id) {
        const name = prompt('New name (blank=skip)');
        const email = prompt('New email (blank=skip)');
        const spec = prompt('New specialization (blank=skip)');
        const payload = {};
        if (name) payload.name = name;
        if (email) payload.email = email;
        if (spec) payload.specialization = spec;
        try {
            const res = await fetch('/api/teachers/' + id + '/', {
                method: 'PATCH',
                headers: {'Content-Type':'application/json', ...authHeaders()},
                body: JSON.stringify(payload)
            });
            if (!res.ok) { return handleApiError(res); }
            await res.json();
            loadTeachers();
        } catch (err) { alert(err.message); }
    }
    document.getElementById('createForm').addEventListener('submit', createTeacher);
    loadTeachers();
</script>
{% endblock %}
