
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h3>Students</h3>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">+ Add Student</button>
</div>

<table class="table table-striped mt-3" id="studentsTable">
    <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Enroll #</th><th>Courses</th><th>Actions</th></tr></thead>
    <tbody></tbody>
</table>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Create Student</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="createForm">
                <div class="mb-2"><label class="form-label">Name</label><input class="form-control" id="c_name" required></div>
                <div class="mb-2"><label class="form-label">Email</label><input type="email" class="form-control" id="c_email" required></div>
                <div class="mb-2"><label class="form-label">Enrollment #</label><input class="form-control" id="c_enroll" required></div>
                <div class="mb-2"><label class="form-label">Course IDs (comma sep)</label><input class="form-control" id="c_courses" placeholder="e.g. 1,2"></div>
                <button class="btn btn-primary" type="submit">Create</button>
            </form>
        </div>
    </div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadStudents() {
        const res = await fetch('/api/students/');
        const data = await res.json();
        const tbody = document.querySelector('#studentsTable tbody');
        tbody.innerHTML = '';
        data.forEach(s => {
            const tr = document.createElement('tr');
            const courseNames = (s.courses || []).map(c => c.code).join(', ');
            tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>${s.enrollment_number}</td>
            <td>${courseNames}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editStudent(${s.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">Delete</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    async function createStudent(e) {
        e.preventDefault();
        const body = {
            name: document.getElementById('c_name').value.trim(),
            email: document.getElementById('c_email').value.trim(),
            enrollment_number: document.getElementById('c_enroll').value.trim(),
        };
        const ids = document.getElementById('c_courses').value.trim();
        if (ids) body.course_ids = ids.split(',').map(x => parseInt(x));
        try {
            const res = await fetch('/api/students/', {
                method: 'POST',
                headers: {'Content-Type':'application/json', ...authHeaders()},
                body: JSON.stringify(body)
            });
            if (!res.ok) { return handleApiError(res); }
            await res.json();
            document.querySelector('#createModal .btn-close').click();
            loadStudents();
        } catch (err) { alert(err.message); }
    }
    async function deleteStudent(id) {
        if (!confirm('Delete student #' + id + '?')) return;
        try {
            const res = await fetch('/api/students/' + id + '/', {
            method: 'DELETE',
            headers: authHeaders()
            });
            if (!res.ok) { const d = await res.text(); throw new Error(res.status + ': ' + d); }
            loadStudents();
        } catch (err) { alert(err.message); }
    }
    async function editStudent(id) {
        const name = prompt('New name (leave blank to skip)');
        const email = prompt('New email (blank=skip)');
        const enroll = prompt('New enrollment # (blank=skip)');
        const payload = {};
        if (name) payload.name = name;
        if (email) payload.email = email;
        if (enroll) payload.enrollment_number = enroll;
        try {
            const res = await fetch('/api/students/' + id + '/', {
                method: 'PATCH',
                headers: {'Content-Type':'application/json', ...authHeaders()},
                body: JSON.stringify(payload)
            });
            if (!res.ok) { return handleApiError(res); }
            await res.json();
            loadStudents();
        } catch (err) { alert(err.message); }
    }
    document.getElementById('createForm').addEventListener('submit', createStudent);
    loadStudents();
</script>
{% endblock %}
